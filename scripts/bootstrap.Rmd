---
title: "Bootstraping"
author: "Aaron Mohammed"
output: github_document
---

```{r setup, include=FALSE}

main_path <- c('/Users/asm/Documents/git_for_jobs')
bootstrap_path <- file.path(main_path, "bootstrap")
dir.create(bootstrap_path)

raw_data_path <- c('/Users/asm/Creighton/celegan/worm_20221014.rds')

```

```{r, warning = FALSE, message = FALSE}

library(Seurat)
library(SingleCellExperiment)
library(R.utils)

readRDS(raw_data_path) -> seurat_data

Idents(seurat_data)<-"tissue"
tissuez <- names(table(seurat_data[[]]$tissue))

genotypez <- list(c("N2D1","N2D1R","N2OPD1"),
                  "N2D6","N2D12","N2D14",
                  "LIPL4D6","DAF2D6","RSKS1D6")

```

```{r, echo=TRUE, warning = FALSE, message = FALSE}

for (t in tissuez) {
  
  # Create a folder for each tissue
  dir.create(file.path(bootstrap_path,t))
  tissue_path <- file.path(bootstrap_path, t)
  
  # Subset the tissue 
  Idents(seurat_data) <- "tissue"
  subset(seurat_data,idents = t) -> tissue_subset
  Idents(tissue_subset) <- "orig.ident"
  
  for (g in genotypez) {
    # Subset genotype
    tmp <- subset(tissue_subset, idents = g)
    
    # Extract count data from genotype subset
    counts <- tmp@assays$RNA@counts 
    metadata <- tmp@meta.data
    sce <- SingleCellExperiment(assays = list(counts = counts), 
                                colData = metadata)
    cells <- colData(sce)[, c("genotype")]
  
    # For statistical significance, skip if there are less than 50 cells
    if (length(cells) >= 50) { 
      
      # Create a character vector that will be used for labeling cells
      # This vector has the same length as the number of cells
      labels <- rep('neg',length(cells))
      
      # Randomly change 15 labels in the vector from neg to pos
      'pos' -> labels[sample(c(1:length(cells)),
                             size=15, 
                             replace=FALSE)]
      
      # Aggregate the count matrix according to the labels
      samp <- Matrix.utils:::aggregate.Matrix(t(counts(sce)), 
                                              groupings = labels,
                                              fun = "sum") 
      
      # Extract the aggregated counts for the cells that were labeled as pos and
      # store in a data frame called Day
      Day <- data.frame(samp = samp['pos',])
      
      # Repeat the same steps 100 more times and each time append the result to
      # the Day data frame
      for (i in 1:100){ 
        
        labels <- rep('neg',length(cells))
        'pos' -> labels[sample(c(1:length(cells)),
                               size=15,
                               replace=FALSE)]
        samp <- Matrix.utils:::aggregate.Matrix(t(counts(sce)), 
                                                   groupings = labels, 
                                                   fun = "sum") 
        Day <- cbind(Day,samp['pos',])
      }
      
        # Save the Day data frame as a csv file in the tissue directory
        if (length(g) == 3) {
          write.csv(Day, file.path(tissue_path, "N2D1.csv"))
        } else {
          write.csv(Day, file.path(tissue_path, 
                                   paste0(g, ".csv")))
        }
    }
  }
}

```

```{r, echo=TRUE, warning = FALSE, message = FALSE}

# Here is an example of what one of the data frames looks like. What's displayed
# is the first 10 genes and first 5 columns of aggregated counts. Each data 
# frame has 26208 rows and 101 columns

tissue_path <- file.path(bootstrap_path, "Neuron")

N2D1 <- read.csv(file.path(tissue_path, "N2D1.csv"), row.names = 1)
N2D1[1:10, 1:4]

```

```{r, echo=TRUE, warning = FALSE, message = FALSE}

# Some time points for N2 were skipped because they had less than 50 cells. I
# wrote a function to find which tissue directories had all four data sets for
# N2 and copy them to a new directory.

# Create a directory where the files for the tissues with all 4 time points for 
# N2 will be copied to 
all_timepoints_dir <- file.path(bootstrap_path,c("tissues_w_all_N2_timepoints"))
dir.create(all_timepoints_dir)

# Filtering function
filter.by.N2 <- function (tissue) {
  
  # List the files in that contain 'N2' in their name within the tissue 
  # directory being evaluated
  contents <- dir(file.path(bootstrap_path, tissue),pattern = "N2")
  
  # Determine the number of files that contain 'N2' in their name and store that
  # number in a variable called l 
  l <- length(contents)

  # If l is equal to 4, copy the tissue directory being evaluated to the
  # 'tissues_with_all_N2_timepoints' directory
  if (l == 4) {
    new_tissue_dir <- file.path(all_timepoints_dir, 
                                tissue)
    
    copyDirectory(file.path(bootstrap_path, tissue), 
                  new_tissue_dir)
  }
}

```

```{r, echo=TRUE, warning = FALSE, message = FALSE}
  
# Run the filtering function
for (i in 1:length(tissuez)) {
  filter.by.N2(tissuez[i])
}

# These were the tissues with all 4 time points for N2
tissuez <- list.dirs(all_timepoints_dir,
                     full.names=FALSE, 
                     recursive= FALSE)

tissuez

```
